apiVersion: v1
kind: ConfigMap
metadata:
  name: nifi-ssl-cm
data:
  security.sh: |
    #!/bin/sh
    set -eu

    NIFI_HOME=/opt/nifi/nifi-current
    TLS_DIR="${TLS_DIR:-/opt/nifi/tls}"

    KEYSTORE="${TLS_DIR}/keystore.p12"
    TRUSTSTORE="${TLS_DIR}/truststore.p12"
    NIFI_CRT="${TLS_DIR}/nifi.crt"

    PASSWORD="${KEYSTORE_PASSWORD:-changeit}"

    POD_NAME="$(hostname)"
    HOSTNAME_FQDN="$(hostname -f)"

    NAMESPACE="${NAMESPACE:-default}"
    HEADLESS_SERVICE="${HEADLESS_SERVICE:-nifi-headless}"
    REPLICAS="${REPLICAS:-2}"

    NODEPORT_HOST="${NIFI_NODEPORT_HOST:-}"
    NODEPORT_PORT="${NIFI_NODEPORT_PORT:-}"

    echo "Pod: ${POD_NAME}"
    echo "FQDN: ${HOSTNAME_FQDN}"
    echo "TLS dir: ${TLS_DIR}"

    mkdir -p "${TLS_DIR}"
    chmod 0770 "${TLS_DIR}" 2>/dev/null || true

    # -----------------------------
    # Build SAN list
    # -----------------------------
    SAN="dns:${HOSTNAME_FQDN},dns:${POD_NAME}"

    i=0
    while [ "$i" -lt "$REPLICAS" ]; do
      SAN="${SAN},dns:nifi-${i}.${HEADLESS_SERVICE}.${NAMESPACE}.svc.cluster.local"
      i=`expr $i + 1`
    done

    if [ -n "${NODEPORT_HOST}" ]; then
      case "${NODEPORT_HOST}" in
        *.*.*.*) SAN="${SAN},ip:${NODEPORT_HOST}" ;;
        *)       SAN="${SAN},dns:${NODEPORT_HOST}" ;;
      esac
    fi

    echo "SAN=${SAN}"

    # -----------------------------
    # Generate TLS once
    # -----------------------------
    if [ ! -f "${KEYSTORE}" ] || [ ! -f "${TRUSTSTORE}" ]; then
      echo "Generating TLS material"

      rm -f "${KEYSTORE}" "${TRUSTSTORE}" "${NIFI_CRT}" 2>/dev/null || true

      keytool -genkeypair \
        -alias nifi \
        -keyalg RSA \
        -keysize 2048 \
        -storetype PKCS12 \
        -keystore "${KEYSTORE}" \
        -storepass "${PASSWORD}" \
        -keypass "${PASSWORD}" \
        -dname "CN=${HOSTNAME_FQDN}" \
        -ext "SAN=${SAN}" \
        -validity 3650

      keytool -exportcert \
        -alias nifi \
        -keystore "${KEYSTORE}" \
        -storepass "${PASSWORD}" \
        -rfc \
        -file "${NIFI_CRT}"

      keytool -importcert \
        -alias nifi \
        -file "${NIFI_CRT}" \
        -keystore "${TRUSTSTORE}" \
        -storetype PKCS12 \
        -storepass "${PASSWORD}" \
        -noprompt

      chmod 0640 "${KEYSTORE}" "${TRUSTSTORE}" "${NIFI_CRT}" || true
    else
      echo "TLS already exists â€“ reusing"
    fi

    # -----------------------------
    # Helper to update nifi.properties
    # -----------------------------
    prop_replace() {
      KEY="$1"
      VAL="$2"
      FILE="${NIFI_HOME}/conf/nifi.properties"

      if grep -q "^${KEY}=" "${FILE}"; then
        sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "${FILE}"
      else
        echo "${KEY}=${VAL}" >> "${FILE}"
      fi
    }

    # -----------------------------
    # TLS config
    # -----------------------------
    prop_replace nifi.security.keystore "${KEYSTORE}"
    prop_replace nifi.security.keystoreType PKCS12
    prop_replace nifi.security.keystorePasswd "${PASSWORD}"
    prop_replace nifi.security.keyPasswd "${PASSWORD}"

    prop_replace nifi.security.truststore "${TRUSTSTORE}"
    prop_replace nifi.security.truststoreType PKCS12
    prop_replace nifi.security.truststorePasswd "${PASSWORD}"

    # -----------------------------
    # Proxy config (CRITICAL)
    # -----------------------------
    PROXY_HOSTS=""

    if [ -n "${NODEPORT_HOST}" ] && [ -n "${NODEPORT_PORT}" ]; then
      PROXY_HOSTS="${NODEPORT_HOST}:${NODEPORT_PORT}"
    fi

    i=0
    while [ "$i" -lt "$REPLICAS" ]; do
      INTERNAL="nifi-${i}.${HEADLESS_SERVICE}.${NAMESPACE}.svc.cluster.local:8443"
      if [ -z "${PROXY_HOSTS}" ]; then
        PROXY_HOSTS="${INTERNAL}"
      else
        PROXY_HOSTS="${PROXY_HOSTS},${INTERNAL}"
      fi
      i=`expr $i + 1`
    done

    prop_replace nifi.web.proxy.context.path /nifi
    prop_replace nifi.web.proxy.host "${PROXY_HOSTS}"

    echo "Proxy hosts: ${PROXY_HOSTS}"
    echo "TLS + proxy setup complete"
