apiVersion: v1
kind: ConfigMap
metadata:
  name: nifi-ssl-cm
data:
  security.sh: |
    #!/bin/sh
    set -eu
    
    NIFI_HOME=/opt/nifi/nifi-current
    TLS_BASE_DIR="/opt/nifi/tls"
    
    POD_NAME="$(hostname | cut -d. -f1)"
    
    KEYSTORE="${TLS_BASE_DIR}/keystore.p12"
    NIFI_CRT="${TLS_BASE_DIR}/nifi.crt"
    TRUSTSTORE="${TLS_BASE_DIR}/truststore.p12"
    
    PASSWORD="${KEYSTORE_PASSWORD:-changeit}"
    
    HOSTNAME_FQDN="$(hostname -f)"
    NAMESPACE="${POD_NAMESPACE:-default}"
    HEADLESS_SERVICE="${HEADLESS_SERVICE:-nifi-headless}"
    REPLICAS="${REPLICAS:-2}"
    
    NODEPORT_HOST="${NIFI_NODEPORT_HOST:-}"
    NODEPORT_PORT="${NIFI_NODEPORT_PORT:-}"
    
    echo "Pod: ${POD_NAME}"
    echo "TLS base dir: ${TLS_BASE_DIR}"
    
    # chmod 0770 "${TLS_BASE_DIR}" "${POD_TLS_DIR}" || true
    
    # -----------------------------
    # SAN list
    # -----------------------------
    SAN="dns:${POD_NAME},dns:${HOSTNAME_FQDN}"
    
    i=0
    while [ "$i" -lt "$REPLICAS" ]; do
    SAN="${SAN},dns:nifi-${i}.${HEADLESS_SERVICE}.${NAMESPACE}.svc.cluster.local"
    i=$((i+1))
    done
    
    [ -n "${NODEPORT_HOST}" ] && SAN="${SAN},dns:${NODEPORT_HOST}"
    
    echo "SAN=${SAN}"
    
    # -----------------------------
    # Per-pod keystore
    # -----------------------------
    if [ ! -f "${KEYSTORE}" ]; then
    echo "Generating keystore for ${POD_NAME}"
    
    keytool -genkeypair \
    -alias nifi \
    -keyalg RSA \
    -keysize 2048 \
    -storetype PKCS12 \
    -keystore "${KEYSTORE}" \
    -storepass "${PASSWORD}" \
    -keypass "${PASSWORD}" \
    -dname "CN=${HOSTNAME_FQDN}" \
    -ext "SAN=${SAN}" \
    -validity 3650
    
    keytool -exportcert \
    -alias nifi \
    -keystore "${KEYSTORE}" \
    -storepass "${PASSWORD}" \
    -rfc \
    -file "${NIFI_CRT}"
    else
    echo "Keystore already exists for ${POD_NAME} â€“ reusing"
    fi
    
    # -----------------------------
    # Shared truststore
    # -----------------------------
    if [ ! -f "${TRUSTSTORE}" ]; then
    echo "Creating shared truststore"
    keytool -genkeypair \
    -alias init \
    -keystore "${TRUSTSTORE}" \
    -storetype PKCS12 \
    -storepass "${PASSWORD}" \
    -dname "CN=init" >/dev/null 2>&1
    keytool -delete -alias init -keystore "${TRUSTSTORE}" -storepass "${PASSWORD}" >/dev/null 2>&1
    fi
    
    TRUST_ALIAS="nifi-${POD_NAME}"
    keytool -delete -alias "${TRUST_ALIAS}" -keystore "${TRUSTSTORE}" -storepass "${PASSWORD}" >/dev/null 2>&1 || true
    keytool -importcert \
    -alias "${TRUST_ALIAS}" \
    -file "${NIFI_CRT}" \
    -keystore "${TRUSTSTORE}" \
    -storepass "${PASSWORD}" \
    -noprompt
    
    # -----------------------------
    # nifi.properties
    # -----------------------------
    prop_replace() {
    grep -q "^$1=" "$NIFI_HOME/conf/nifi.properties" \
    && sed -i "s|^$1=.*|$1=$2|" "$NIFI_HOME/conf/nifi.properties" \
      || echo "$1=$2" >> "$NIFI_HOME/conf/nifi.properties"
    }
    
    prop_replace nifi.security.keystore "${KEYSTORE}"
    prop_replace nifi.security.keystoreType PKCS12
    prop_replace nifi.security.keystorePasswd "${PASSWORD}"
    prop_replace nifi.security.keyPasswd "${PASSWORD}"
    
    prop_replace nifi.security.truststore "${TRUSTSTORE}"
    prop_replace nifi.security.truststoreType PKCS12
    prop_replace nifi.security.truststorePasswd "${PASSWORD}"
    
    
    echo "TLS setup complete for ${POD_NAME}"
