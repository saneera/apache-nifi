---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nifi-config
data:
  NIFI_WEB_HTTP_PORT: ""
  NIFI_WEB_HTTPS_PORT: "8443"

  # ðŸ‘‡ REQUIRED for NodePort
  NIFI_WEB_PROXY_HOST: "localhost:30084"

  # ðŸ‘‡ CLUSTER MODE
  NIFI_CLUSTER_IS_NODE: "true"
  NIFI_CLUSTER_NODE_PROTOCOL_PORT: "11443"

  # ðŸ‘‡ ZooKeeper
  NIFI_ZK_CONNECT_STRING: "zookeeper:2181"

  NIFI_ELECTION_MAX_WAIT: "1 min"
  NIFI_ELECTION_RETRY_WAIT: "30 sec"
  NIFI_SENSITIVE_PROPS_KEY: "ChangeMeForProd"
  NIFI_SECURITY_KEYSTORE: "/opt/nifi/nifi-cert/keystore.jks"
  NIFI_SECURITY_KEYSTORE_TYPE: "JKS"
  NIFI_SECURITY_KEYSTORE_PASSWD: "ChangeMeForProd"
  NIFI_SECURITY_KEY_PASSWD: "ChangeMeForProd"
  NIFI_SECURITY_TRUSTSTORE: "/opt/nifi/nifi-cert/truststore.jks"
  NIFI_SECURITY_TRUSTSTORE_TYPE: "JKS"
  NIFI_SECURITY_TRUSTSTORE_PASSWD: "ChangeMeForProd"


---

apiVersion: v1
kind: Secret
metadata:
  name: nifi-tls
type: Opaque
data:
  keystore.jks: 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
  truststore.jks: MIIE0gIBAzCCBHwGCSqGSIb3DQEHAaCCBG0EggRpMIIEZTCCBGEGCSqGSIb3DQEHBqCCBFIwggROAgEAMIIERwYJKoZIhvcNAQcBMGYGCSqGSIb3DQEFDTBZMDgGCSqGSIb3DQEFDDArBBRN5w+lfg9aBHb68C2Cccs3JW08JgICJxACASAwDAYIKoZIhvcNAgkFADAdBglghkgBZQMEASoEEPFbM8DDBglUvIwRj5bbFdiAggPQniBOiTF4UsPOWKVAwQbT6Hbr0uuHjBR+6gwc4BOM9tEDv2jqNAhYMc7+vKnCphWfOX+OptVyGmkQzbjlIQ71NxZY4XSRDZQDShnBcXEejs7wvkee+PKGC3t4XhV/bu3Vm0z01h49nn0zXgMf25Hylq0Eu0f3tZJjc34Dz5TSfcJTUAeBDat2Y/ity/43Rzqyyvi3ISDqioOCzBlbnCqQdYsEsc/cGZsIADp2o6pBDkObilV6xmjEoDqdJ1fHdjZ6r3CGuAZ5fvT/FvkdiBPfaLXIvqGWaHwbgZajH4hizWtpwpD4fy7Rm6/wjVCFzciY55IQ9s7yG9+VzRcrEwNE2vubmAFQGlp3/S/MHMMYrQ5R+690k6KlMvv+hI/KmZAkYb//WwypvwMNeuet1JTahKYPtOxlMt7GZVAhxCn6d4CvFJ7/RccsbHgXTrndTpsZWIjntbgFlacGLiNr8sp2ezgPSoTwyoht64eyDykaR8AI5U3aQyjZHuMuHGcQzg/7zX+h9Mhzr6z2p1hnk3i2bUbejROWluCino7uSrLeC8FFiNX5JOud2+4vCViO1b+Bd4YHlkj+peHnbyUpZEhUpua0GwKAxprqvndm5GIMYBI0gpiEoooLrFjx6Py+2FPP50u0XJb1tUg4DkUjvUfsHLOlpadMxM4PX6jAIl+nonZOpFK2Gs/NWg8ahPwBTrUoSt58x3fUcavJifRyQ4aKcPh9WuZY9eKV6XeiFAtehER17e07TyJSre5E7TEcz4Js7XIGnH5eh7Cargy5OfNZHdgKbsp5NH8fOrN8gpkA99l5dILPNwAx9dYuwYoK8xZbt1lfLlWJwbxShHFUJkpS3WqaKQo9gNZGIUd9EqIOybK/jBlQOFPcgV+zkSk1STFsPw8uM94KP9Ht5qKGB1hTq20wKnpAof12z02AKPaWJJZpkJMS08kguN9a5+72axv1mL14fCklcIef4jQFNs/9NcHdFW8FiZwC6pBw4Rr80177me9LlhqY6dXDhMKf30x5gMXyY1XwyLgTYoT9oIBdrNfo9VWUFdBtJ4MtkgGZc7jUpUO25Ks91DyPTIwF2PKGdE8cXo3sG5vQl8q8iQ0WWDoxC4kecvebPtexfGVUWSSlwt9MjBEtu6KSr7cYrJQZhC5j8F6uAxcCG6dPoYQzqkJ35xMUb0UpKiRLmIdSAIdIxucI94D6NgjCA6EK6xhIkmxQPSWotIkyRjor1wF4r9fX5/JFwZfGHC8Ga0dveI+PRH1/wIlaTrAZ02MnLUemzOGtTUgVilDqRJ2lQX+iZjBNMDEwDQYJYIZIAWUDBAIBBQAEIKA0RKULyaM+bs74TQd8fE1C4tDORNJJkZDIJLM7VeuEBBSVY9V40Q4M7x5uMf4whDJTFnu4pgICJxA=

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nifi
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nifi
  template:
    metadata:
      labels:
        app: nifi
    spec:
      initContainers:
        - name: busybox
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              echo "Connecting to Zookeeper ${NIFI_ZK_CONNECT_STRING}"
              until nc -vzw 1 zookeeper 2181 ; do
                echo "Waiting for zookeeper to start"
                sleep 3
              done
      containers:
        - name: nifi
          image: apache/nifi:2.7.0
          ports:
            - containerPort: 8443
          envFrom:
            - configMapRef:
                name: nifi-config
            - secretRef:
                name: nifi-auth

          volumeMounts:
            - name: nifi-cert
              mountPath: /opt/nifi/tls

      volumes:
        - name: nifi-config
          configMap:
            name: nifi-config
        - name: nifi-cert
          secret:
            secretName: nifi-tls

---

apiVersion: v1
kind: Service
metadata:
  name: nifi
spec:
  type: NodePort
  selector:
    app: nifi
  ports:
    - name: https
      port: 8443
      targetPort: 8443
      nodePort: 30084   # NodePort range: 30000-32767


