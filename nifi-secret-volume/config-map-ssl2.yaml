apiVersion: v1
kind: ConfigMap
metadata:
  name: nifi-ssl-cm
data:
  security.sh: |
    #!/bin/sh
    set -eu

    NIFI_HOME="${NIFI_HOME:-/opt/nifi/nifi-current}"

    # You mount the PVC here:
    TLS_BASE_DIR="${TLS_BASE_DIR:-${NIFI_HOME}/tls}"

    # Per-pod keystore dir
    POD_NAME="${POD_NAME:-$(hostname)}"
    POD_FQDN="${POD_FQDN:-$(hostname -f)}"

    NODE_TLS_DIR="${TLS_BASE_DIR}/${POD_NAME}"
    KEYSTORE="${NODE_TLS_DIR}/keystore.p12"
    NODE_CRT="${NODE_TLS_DIR}/nifi-${POD_NAME}.crt"

    # Shared truststore across pods
    TRUSTSTORE="${TLS_BASE_DIR}/truststore.p12"

    PASSWORD="${KEYSTORE_PASSWORD:-changeit}"

    # cluster dns inputs
    NAMESPACE="${POD_NAMESPACE:-${NAMESPACE:-default}}"
    HEADLESS_SERVICE="${NIFI_HEADLESS_SERVICE:-${HEADLESS_SERVICE:-nifi-headless}}"
    REPLICAS="${REPLICAS:-2}"

    # NodePort inputs
    NODEPORT_HOST="${NIFI_NODEPORT_HOST:-}"
    NODEPORT_PORT="${NIFI_NODEPORT_PORT:-}"

    echo "== security.sh =="
    echo "POD_NAME=${POD_NAME}"
    echo "POD_FQDN=${POD_FQDN}"
    echo "TLS_BASE_DIR=${TLS_BASE_DIR}"
    echo "NODE_TLS_DIR=${NODE_TLS_DIR}"
    echo "TRUSTSTORE=${TRUSTSTORE}"

    mkdir -p "${TLS_BASE_DIR}" "${NODE_TLS_DIR}" 2>/dev/null || true
    chmod 0770 "${TLS_BASE_DIR}" "${NODE_TLS_DIR}" 2>/dev/null || true

    # -----------------------------
    # Build SAN list for THIS pod cert
    # Must include:
    # - this pod's FQDN
    # - this pod short name
    # - all headless DNS names (so UI replication & inter-node calls validate)
    # - optional NodePort host (IP/DNS) for browser SNI
    # -----------------------------
    SAN="dns:${POD_FQDN},dns:${POD_NAME}"

    i=0
    while [ "$i" -lt "$REPLICAS" ]; do
      SAN="${SAN},dns:nifi-${i}.${HEADLESS_SERVICE}.${NAMESPACE}.svc.cluster.local"
      i=`expr "$i" + 1`
    done

    if [ -n "${NODEPORT_HOST}" ]; then
      case "${NODEPORT_HOST}" in
        *.*.*.*) SAN="${SAN},ip:${NODEPORT_HOST}" ;;
        *)       SAN="${SAN},dns:${NODEPORT_HOST}" ;;
      esac
    fi

    echo "SAN=${SAN}"

    # -----------------------------
    # Generate per-pod keystore (unique identity per node)
    # -----------------------------
    if [ ! -f "${KEYSTORE}" ]; then
      echo "Generating keystore for ${POD_NAME}"

      rm -f "${KEYSTORE}" "${NODE_CRT}" 2>/dev/null || true

      keytool -genkeypair \
        -alias nifi \
        -keyalg RSA \
        -keysize 2048 \
        -storetype PKCS12 \
        -keystore "${KEYSTORE}" \
        -storepass "${PASSWORD}" \
        -keypass "${PASSWORD}" \
        -dname "CN=${POD_FQDN}" \
        -ext "SAN=${SAN}" \
        -validity 3650

      keytool -exportcert \
        -alias nifi \
        -keystore "${KEYSTORE}" \
        -storepass "${PASSWORD}" \
        -rfc \
        -file "${NODE_CRT}"

      chmod 0640 "${KEYSTORE}" "${NODE_CRT}" 2>/dev/null || true
    else
      echo "Keystore exists for ${POD_NAME} â€“ reusing ${KEYSTORE}"
    fi

    # -----------------------------
    # Ensure shared truststore exists and trusts BOTH nodes.
    # We import each node cert under a unique alias.
    # -----------------------------
    if [ ! -f "${TRUSTSTORE}" ]; then
      echo "Creating shared truststore ${TRUSTSTORE}"
      # create empty truststore by importing this node's cert first
      keytool -importcert \
        -alias "nifi-${POD_NAME}" \
        -file "${NODE_CRT}" \
        -keystore "${TRUSTSTORE}" \
        -storetype PKCS12 \
        -storepass "${PASSWORD}" \
        -noprompt
      chmod 0640 "${TRUSTSTORE}" 2>/dev/null || true
    else
      # add/replace this node cert into truststore
      keytool -delete \
        -alias "nifi-${POD_NAME}" \
        -keystore "${TRUSTSTORE}" \
        -storetype PKCS12 \
        -storepass "${PASSWORD}" 2>/dev/null || true

      keytool -importcert \
        -alias "nifi-${POD_NAME}" \
        -file "${NODE_CRT}" \
        -keystore "${TRUSTSTORE}" \
        -storetype PKCS12 \
        -storepass "${PASSWORD}" \
        -noprompt
    fi

    # -----------------------------
    # Helper to update nifi.properties
    # -----------------------------
    prop_replace() {
      KEY="$1"
      VAL="$2"
      FILE="${NIFI_HOME}/conf/nifi.properties"

      if grep -q "^${KEY}=" "${FILE}"; then
        sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "${FILE}"
      else
        echo "${KEY}=${VAL}" >> "${FILE}"
      fi
    }

    # -----------------------------
    # Point NiFi to per-pod keystore + shared truststore
    # -----------------------------
    prop_replace nifi.security.keystore "${KEYSTORE}"
    prop_replace nifi.security.keystoreType PKCS12
    prop_replace nifi.security.keystorePasswd "${PASSWORD}"
    prop_replace nifi.security.keyPasswd "${PASSWORD}"

    prop_replace nifi.security.truststore "${TRUSTSTORE}"
    prop_replace nifi.security.truststoreType PKCS12
    prop_replace nifi.security.truststorePasswd "${PASSWORD}"

    # -----------------------------
    # Proxy config: allow NodePort + internal hosts
    # Must include whatever host:port the browser uses AND internal node hostnames
    # -----------------------------
    PROXY_HOSTS=""

    if [ -n "${NODEPORT_HOST}" ] && [ -n "${NODEPORT_PORT}" ]; then
      PROXY_HOSTS="${NODEPORT_HOST}:${NODEPORT_PORT}"
    fi

    i=0
    while [ "$i" -lt "$REPLICAS" ]; do
      INTERNAL="nifi-${i}.${HEADLESS_SERVICE}.${NAMESPACE}.svc.cluster.local:8443"
      if [ -z "${PROXY_HOSTS}" ]; then
        PROXY_HOSTS="${INTERNAL}"
      else
        PROXY_HOSTS="${PROXY_HOSTS},${INTERNAL}"
      fi
      i=`expr "$i" + 1`
    done

    prop_replace nifi.web.proxy.context.path "${NIFI_WEB_PROXY_CONTEXT_PATH:-/nifi}"
    prop_replace nifi.web.proxy.host "${PROXY_HOSTS}"

    echo "Proxy hosts: ${PROXY_HOSTS}"
    echo "TLS setup complete."
